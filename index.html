<!DOCTYPE html>
<html lang="id">
<head>
  <script>
    if (localStorage.getItem("loggedIn") !== "true") {
      window.location.href = "login.html";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alat Kerja DDIM</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bevan&display=swap" rel="stylesheet">
</head>
<body>
  <div class="header glossy-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <div class="left-title">DDiM Tools</div>
    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
      <button onclick="openQRModal()">Cetak Barcode</button>

      <div class="summary-dropdown" id="summaryDropdown">
        <button id="summaryButton">Ringkasan <span class="arrow">▼</span></button>
        <div class="dropdown-content" id="dropdownContent" style="display:none;">
          <p>Total Alat: <span id="totalAlat">0</span></p>
          <p>Alat Aktif: <span id="alatAktif">0</span></p>
          <p>Alat Rusak: <span id="alatRusak" style="cursor:pointer; text-decoration:underline;">0</span></p>
        </div>
      </div>

      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="grid-container">
    <div class="box" onclick="navigateTo(1)"><img src="./assets/img/toolbox.png" alt="Box 1" /><p>Box Alat 1</p></div>
    <div class="box" onclick="navigateTo(2)"><img src="./assets/img/toolbox.png" alt="Box 2" /><p>Box Alat 2</p></div>
    <div class="box" onclick="navigateTo(3)"><img src="./assets/img/toolbox.png" alt="Box 3" /><p>Box Alat 3</p></div>
    <div class="box" onclick="navigateTo(4)"><img src="./assets/img/toolbox.png" alt="Box 4" /><p>Box Alat 4</p></div>
    <div class="box" onclick="navigateTo(5)"><img src="./assets/img/toolbox.png" alt="Box 5" /><p>Box Alat 5</p></div>
    <div class="box" onclick="navigateTo(6)"><img src="./assets/img/toolbox.png" alt="Box 6" /><p>Box Alat 6</p></div>
  </div>

  <div class="footer">© 2025 DDIM</div>

  <!-- Modal rusak -->
  <div id="popupModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h2>Daftar Alat Rusak</h2>
      <ul id="rusakList"></ul>
    </div>
  </div>

  <!-- Modal QR -->
  <div id="qr-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Pilih Box</h3>
      <select id="boxSelect">
        <option value="1">Box 1</option>
        <option value="2">Box 2</option>
        <option value="3">Box 3</option>
        <option value="4">Box 4</option>
        <option value="5">Box 5</option>
        <option value="6">Box 6</option>
      </select>
      <button onclick="printQR()">Cetak QR</button>
      <button onclick="closeQRModal()">Batal</button>
    </div>
  </div>

  <div id="qr-print-area" style="display: none; text-align: center; padding-top: 50px;">
    <h2 id="qr-title"></h2>
    <div id="qr-code-print"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBUXwnG_xx1S5RUGLzxIRev-4Pocbpyz_3woiGL2qAjtbI6bC3jRoaFMy2z_b0RYkjBQ/exec";
    const loggedInUser = localStorage.getItem("loggedInUser");

    async function fetchAlatFromServer() {
      let total = 0, aktif = 0, rusak = 0;
      const rusakItems = [];

      for (let box = 1; box <= 6; box++) {
        const res = await fetch(`${SCRIPT_URL}?action=getAlat&username=${loggedInUser}&box=${box}`);
        const result = await res.json();

        if (result.success && Array.isArray(result.alatList)) {
          total += result.alatList.length;
          aktif += result.alatList.filter(a => (a.status || "").toLowerCase() === "baik").length;
          const rusakInBox = result.alatList.filter(a => (a.status || "").toLowerCase() === "rusak");

          rusak += rusakInBox.length;
          rusakInBox.forEach(item => rusakItems.push(`${item.nama} (Box ${box})`));
        }
      }

      // Update tampilan
      document.getElementById("totalAlat").textContent = total;
      document.getElementById("alatAktif").textContent = aktif;
      document.getElementById("alatRusak").textContent = rusak;

      return rusakItems;
    }

    function openQRModal() {
      document.getElementById("qr-modal").style.display = "flex";
    }

    function closeQRModal() {
      document.getElementById("qr-modal").style.display = "none";
    }

    function printQR() {
      const boxId = document.getElementById("boxSelect").value;
      const qrArea = document.getElementById("qr-code-print");
      const qrTitle = document.getElementById("qr-title");

      qrArea.innerHTML = "";
      qrTitle.textContent = `QR Code - Box ${boxId}`;

      const url = `${window.location.origin}/list.html?box=${boxId}`;
      new QRCode(qrArea, { text: url, width: 200, height: 200 });

      document.getElementById("qr-print-area").style.display = "block";
      closeQRModal();
      setTimeout(() => window.print(), 500);
    }

    function navigateTo(box) {
      window.location.href = `list.html?box=${box}`;
    }

    function toggleDropdown() {
      const dropdown = document.getElementById("dropdownContent");
      const arrow = document.querySelector(".summary-dropdown .arrow");
      if (dropdown.style.display === "block") {
        dropdown.style.display = "none";
        arrow.style.transform = "rotate(0deg)";
      } else {
        dropdown.style.display = "block";
        arrow.style.transform = "rotate(180deg)";
      }
    }

    async function showRusakList() {
      const rusakListEl = document.getElementById("rusakList");
      rusakListEl.innerHTML = "<li>Memuat...</li>";
      const rusakItems = await fetchAlatFromServer();

      rusakListEl.innerHTML = "";
      if (rusakItems.length === 0) {
        rusakListEl.innerHTML = "<li>Tidak ada alat rusak.</li>";
      } else {
        rusakItems.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          rusakListEl.appendChild(li);
        });
      }

      document.getElementById("popupModal").style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchAlatFromServer();

      document.getElementById("summaryButton").addEventListener("click", e => {
        e.stopPropagation();
        toggleDropdown();
      });

      document.getElementById("alatRusak").addEventListener("click", e => {
        e.stopPropagation();
        showRusakList();
      });

      document.getElementById("closeModal").addEventListener("click", () => {
        document.getElementById("popupModal").style.display = "none";
      });

      window.addEventListener("click", event => {
        if (event.target === document.getElementById("popupModal")) {
          document.getElementById("popupModal").style.display = "none";
        }

        if (!document.getElementById("summaryButton").contains(event.target)) {
          document.getElementById("dropdownContent").style.display = "none";
          document.querySelector(".summary-dropdown .arrow").style.transform = "rotate(0deg)";
        }
      });
    });

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
