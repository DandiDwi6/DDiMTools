<!DOCTYPE html>
<html lang="id">
<head>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alat Kerja DDIM</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bevan&display=swap" rel="stylesheet">
</head>
<body>
  <div class="header glossy-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <div class="left-title">DDiM Tools</div>
    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
      <button class="primary-btn" onclick="openQRModal()">ðŸ“¦ Cetak Barcode</button>

      <!-- Dropdown Ringkasan -->
      <div class="summary-dropdown" id="summaryDropdown" style="position: relative; z-index: 100;">
        <button id="summaryButton" onclick="toggleDropdown()">ðŸ“Š Ringkasan <span class="arrow">â–¼</span></button>
        <div class="dropdown-content" id="dropdownContent">
          <p>Total Alat: <span id="totalAlat">0</span></p>
          <p>Alat Aktif: <span id="alatAktif">0</span></p>
          <p id="alatRusak" style="cursor:pointer; text-decoration:underline;">Alat Rusak: <span>0</span></p>
        </div>
      </div>

      <button class="danger-btn" onclick="logout()">ðŸšª Logout</button>
    </div>
  </div>

  <div class="grid-container">
    <div class="box" onclick="navigateTo(1)"><img src="./assets/img/toolbox.png" alt="Box 1" /><p>Box Alat 1</p></div>
    <div class="box" onclick="navigateTo(2)"><img src="./assets/img/toolbox.png" alt="Box 2" /><p>Box Alat 2</p></div>
    <div class="box" onclick="navigateTo(3)"><img src="./assets/img/toolbox.png" alt="Box 3" /><p>Box Alat 3</p></div>
    <div class="box" onclick="navigateTo(4)"><img src="./assets/img/toolbox.png" alt="Box 4" /><p>Box Alat 4</p></div>
    <div class="box" onclick="navigateTo(5)"><img src="./assets/img/toolbox.png" alt="Box 5" /><p>Box Alat 5</p></div>
    <div class="box" onclick="navigateTo(6)"><img src="./assets/img/toolbox.png" alt="Box 6" /><p>Box Alat 6</p></div>
  </div>

  <div class="footer">Â© 2025 DDIM</div>

  <!-- Modal Alat Rusak -->
  <div id="popupModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal" style="cursor:pointer; font-size:1.5rem;">&times;</span>
      <h2>Daftar Alat Rusak</h2>
      <ul id="rusakList"></ul>
    </div>
  </div>

  <!-- Modal QR Code -->
  <div id="qr-modal" class="modal">
    <div class="modal-content">
      <h3>Pilih Box</h3>
      <select id="boxSelect">
        <option value="1">Box 1</option>
        <option value="2">Box 2</option>
        <option value="3">Box 3</option>
        <option value="4">Box 4</option>
        <option value="5">Box 5</option>
        <option value="6">Box 6</option>
      </select>
      <button onclick="printQR()">Cetak QR</button>
      <button onclick="closeQRModal()">Batal</button>
    </div>
  </div>

  <!-- Area Cetak QR -->
  <div id="qr-print-area" style="display: none; text-align: center; padding-top: 50px;">
    <h2 id="qr-title"></h2>
    <div id="qr-code-print"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwN54G1AqiIszXGwmdzkgZXcz2Qoc4MDjAZ_sH5Ou-Mok4pfCHsb8n7a1A3gCvjQShkmQ/exec";
    const loggedInUser = localStorage.getItem("loggedInUser");

    async function fetchAlatFromServer() {
      let total = 0, aktif = 0, rusak = 0;
      const rusakItems = [];

      for (let box = 1; box <= 6; box++) {
        try {
          const res = await fetch(`${SCRIPT_URL}?action=getAlat&username=${encodeURIComponent(loggedInUser)}&box=${box}`);
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const result = await res.json();

          if (result.success && Array.isArray(result.alatList)) {
            total += result.alatList.length;
            aktif += result.alatList.filter(a => (a.status || "").toLowerCase() === "baik").length;
            const rusakInBox = result.alatList.filter(a => (a.status || "").toLowerCase() === "rusak");

            rusak += rusakInBox.length;
            rusakInBox.forEach(item => rusakItems.push(`${item.nama} (Box ${box})`));
          }
        } catch (e) {
          console.error(`Error fetching alat box ${box}:`, e);
        }
      }

      document.getElementById("totalAlat").textContent = total;
      document.getElementById("alatAktif").textContent = aktif;
      document.querySelector("#alatRusak span").textContent = rusak;

      return rusakItems;
    }

    function openQRModal() {
  document.getElementById("qr-modal").classList.add("show");
}

    function closeQRModal() {
  document.getElementById("qr-modal").classList.remove("show");
}


    function printQR() {
      const boxId = document.getElementById("boxSelect").value;
      const qrArea = document.getElementById("qr-code-print");
      const qrTitle = document.getElementById("qr-title");

      qrArea.innerHTML = "";
      qrTitle.textContent = `QR Code - Box ${boxId}`;

      const url = `${window.location.origin}/list.html?box=${boxId}`;
      new QRCode(qrArea, { text: url, width: 200, height: 200 });

      document.getElementById("qr-print-area").style.display = "block";
      closeQRModal();
      setTimeout(() => window.print(), 500);
    }

    function navigateTo(box) {
      window.location.href = `list.html?box=${box}`;
    }

    function toggleDropdown() {
      const dropdown = document.getElementById("dropdownContent");
      const arrow = document.querySelector(".summary-dropdown .arrow");
      const isVisible = dropdown.style.display === "block";

      dropdown.style.display = isVisible ? "none" : "block";
      arrow.style.transform = isVisible ? "rotate(0deg)" : "rotate(180deg)";
    }

    async function showRusakList() {
      const rusakListEl = document.getElementById("rusakList");
      rusakListEl.innerHTML = "<li>Memuat...</li>";
      const rusakItems = await fetchAlatFromServer();

      rusakListEl.innerHTML = "";
      if (rusakItems.length === 0) {
        rusakListEl.innerHTML = "<li>Tidak ada alat rusak.</li>";
      } else {
        rusakItems.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          rusakListEl.appendChild(li);
        });
      }

      document.getElementById("popupModal").classList.add("show");

    }

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
        return;
        window.addEventListener("click", event => {
        const qrModal = document.getElementById("qr-modal");
     if (event.target === qrModal) {
        qrModal.classList.remove("show");
  }
});

      }

      await fetchAlatFromServer();

      document.getElementById("alatRusak").addEventListener("click", e => {
        e.stopPropagation();
        showRusakList();
      });

      document.getElementById("closeModal").addEventListener("click", () => {
        document.getElementById("popupModal").classList.remove("show");

      });

      window.addEventListener("click", event => {
        const dropdown = document.getElementById("dropdownContent");
        if (!event.target.closest(".summary-dropdown")) {
          dropdown.style.display = "none";
          document.querySelector(".summary-dropdown .arrow").style.transform = "rotate(0deg)";
        }

        if (event.target === document.getElementById("popupModal")) {
          document.getElementById("popupModal").style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
